<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nabha Telemedicine Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar styling for the chat container - makes it visually consistent with the app design */
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl flex flex-col h-[90vh]">
        <!-- Header section: displays app title, language selector, and status information -->

        <div class="bg-indigo-600 text-white p-4 rounded-t-2xl flex justify-between items-center shadow-md">
            <div>
                <h1 class="text-xl font-bold">Telemedicine Assistant</h1>
                <p class="text-sm opacity-80">ਸਹਾਇਕ | Your Virtual Health Guide</p>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-xs font-semibold">Language:</span>
                <select id="language-switcher" class="bg-indigo-700 text-white text-xs rounded p-1 border-indigo-500 focus:ring-2 focus:ring-white focus:outline-none">
                    <option value="en">English</option>
                    <option value="pa">ਪੰਜਾਬੀ (Punjabi)</option>
                </select>
            </div>
        </div>

        <!-- Main chat area: displays conversation messages from both user and AI assistant -->
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto">
            <!-- Messages will be dynamically inserted here by JavaScript -->
        </div>

        <!-- Quick reply buttons: provides users with predefined action options (symptom check, medicine info) -->

        <div id="quick-replies" class="p-4 border-t border-slate-200">
            <!-- Quick reply buttons will be dynamically generated here by JavaScript -->
        </div>

        <!-- Input section: text field and send button for user messages -->

        <div class="p-4 bg-slate-50 rounded-b-2xl border-t border-slate-200">
            <div class="flex items-center space-x-4">
                <input type="text" id="user-input" placeholder="Type your message..." class="flex-1 w-full px-4 py-3 bg-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-300">
                <button id="send-btn" class="bg-indigo-600 text-white rounded-lg px-6 py-3 font-semibold hover:bg-indigo-700 active:scale-95 transition duration-300 shadow-lg">
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const quickRepliesContainer = document.getElementById('quick-replies');
        const languageSwitcher = document.getElementById('language-switcher');

        // Track the current language selection ('en' or 'pa' for English/Punjabi)
        let currentLanguage = 'en';
        // Track conversation state to manage user flow: 'idle' (no active conversation), 'awaiting_medicine' (waiting for medicine name), 'awaiting_symptom' (waiting for symptom description)
        let conversationState = 'idle';

        const translations = {
            en: {
                welcome: "Welcome to the Telemedicine service. How can I assist you today?",
                symptomCheck: "Symptom Check",
                medicineInfo: "Medicine Availability",
                symptomPrompt: "Please describe your symptoms in detail. For example: 'I have a fever, cough, and headache.'",
                medicinePrompt: "Which medicine are you looking for? Please type the name.",
                pharmacyInfo: (medicine, status) => `Regarding '${medicine}', here is the latest information: <strong>Status: ${status}</strong> at Nabha Civil Hospital Pharmacy.`,
                unknownMedicine: "I'm sorry, I don't have information on that medicine. Please try another name.",
                thinking: "Analyzing your symptoms...",
                aiError: "I'm sorry, I encountered an error while analyzing your symptoms. Please try again.",
                inputPlaceholder: "Type your message...",
                sendButton: "Send"
            },
            pa: {
                welcome: " ਟੈਲੀਮੇਡੀਸਨ ਸੇਵਾ ਵਿੱਚ ਤੁਹਾਡਾ ਸੁਆਗਤ ਹੈ। ਮੈਂ ਅੱਜ ਤੁਹਾਡੀ ਕਿਵੇਂ ਮਦਦ ਕਰ ਸਕਦਾ ਹਾਂ?",
                symptomCheck: "ਲੱਛਣਾਂ ਦੀ ਜਾਂਚ",
                medicineInfo: "ਦਵਾਈ ਦੀ ਉਪਲਬਧਤਾ",
                symptomPrompt: "ਕਿਰਪਾ ਕਰਕੇ ਆਪਣੇ ਲੱਛਣਾਂ ਦਾ ਵਿਸਥਾਰ ਵਿੱਚ ਵਰਣਨ ਕਰੋ। ਉਦਾਹਰਨ ਲਈ: 'ਮੈਨੂੰ ਬੁਖਾਰ, ਖੰਘ ਅਤੇ ਸਿਰ ਦਰਦ ਹੈ।'",
                medicinePrompt: "ਤੁਸੀਂ ਕਿਹੜੀ ਦਵਾਈ ਲੱਭ ਰਹੇ ਹੋ? ਕਿਰਪਾ ਕਰਕੇ ਨਾਮ ਟਾਈਪ ਕਰੋ।",
                pharmacyInfo: (medicine, status) => `'${medicine}' ਦੇ ਸੰਬੰਧ ਵਿੱਚ, ਤਾਜ਼ਾ ਜਾਣਕਾਰੀ ਇਹ ਹੈ: <strong>ਸਥਿਤੀ: ${status}</strong> ਨਾਭਾ ਸਿਵਲ ਹਸਪਤਾਲ ਫਾਰਮੇਸੀ ਵਿਖੇ।`,
                unknownMedicine: "ਮੈਨੂੰ ਮਾਫ਼ ਕਰਨਾ, ਮੇਰੇ ਕੋਲ ਉਸ ਦਵਾਈ ਬਾਰੇ ਜਾਣਕਾਰੀ ਨਹੀਂ ਹੈ। ਕਿਰਪਾ ਕਰਕੇ ਕੋਈ ਹੋਰ ਨਾਮ ਅਜ਼ਮਾਓ।",
                thinking: "ਤੁਹਾਡੇ ਲੱਛਣਾਂ ਦਾ ਵਿਸ਼ਲੇਸ਼ਣ ਕੀਤਾ ਜਾ ਰਿਹਾ ਹੈ...",
                aiError: "ਮੈਨੂੰ ਮਾਫ਼ ਕਰਨਾ, ਤੁਹਾਡੇ ਲੱਛਣਾਂ ਦਾ ਵਿਸ਼ਲੇਸ਼ਣ ਕਰਦੇ ਸਮੇਂ ਮੈਨੂੰ ਇੱਕ ਗਲਤੀ ਆਈ। ਕਿਰਪਾ ਕਰਕੇ ਦੁਬਾਰਾ ਕੋਸ਼ਿਸ਼ ਕਰੋ।",
                inputPlaceholder: "ਆਪਣਾ ਸੁਨੇਹਾ ਟਾਈਪ ਕਰੋ...",
                sendButton: "ਭੇਜੋ"
            }
        };
        
        // Store medicine stock data fetched from Google Sheets, organized by language
        let livePharmacyStock = {};

        // Display a message in the chat container (supports both user and bot messages, with optional HTML rendering)
        function addMessage(text, sender = 'bot', isHtml = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = `rounded-lg px-4 py-2 max-w-lg ${sender === 'user' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-800'}`;
            
            if (isHtml) {
                messageContent.innerHTML = text;
            } else {
                messageContent.textContent = text;
            }

            messageDiv.appendChild(messageContent);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Render quick reply buttons that provide users with predefined action options
        function displayQuickReplies() {
            quickRepliesContainer.innerHTML = '';
            const replies = [
                { text: translations[currentLanguage].symptomCheck, payload: 'symptom_check' },
                { text: translations[currentLanguage].medicineInfo, payload: 'medicine_info' }
            ];

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex flex-wrap gap-2 justify-center';
            
            replies.forEach(reply => {
                const button = document.createElement('button');
                button.textContent = reply.text;
                button.className = 'bg-slate-200 text-indigo-700 font-semibold px-4 py-2 rounded-full hover:bg-indigo-200 transition duration-300';
                button.onclick = () => handleQuickReply(reply.payload);
                buttonContainer.appendChild(button);
            });
            quickRepliesContainer.appendChild(buttonContainer);
        }
        
        // Process quick reply button clicks: display user selection and execute corresponding action
        function handleQuickReply(payload) {
            addMessage(payload.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), 'user');
            quickRepliesContainer.innerHTML = ''; 
            
            setTimeout(() => {
                processPayload(payload);
            }, 500);
        }
        
        // Route user input to the appropriate handler based on conversation state and payload type
        function processPayload(payload) {
             switch (payload) {
                case 'symptom_check':
                    conversationState = 'awaiting_symptom';
                    addMessage(translations[currentLanguage].symptomPrompt);
                    break;
                case 'medicine_info':
                    conversationState = 'awaiting_medicine';
                    addMessage(translations[currentLanguage].medicinePrompt);
                    break;
                default:
                    handleTextMessage(payload);
            }
        }

        // Fetch medicine stock data from Google Sheets and parse it into organized language-specific dictionaries
        async function fetchMedicineStock() {
            const googleSheetUrl = ''; // Add your Google Sheets CSV export URL here

            try {
                // Add timestamp parameter to bypass browser caching and ensure fresh data
                const response = await fetch(`${googleSheetUrl}&_=${new Date().getTime()}`);
                if (!response.ok) {
                    console.error("Failed to fetch medicine stock sheet.");
                    return;
                }
                const csvText = await response.text();
                const rows = csvText.split(/\r?\n/).slice(1); 

                const stock = { en: {}, pa: {} };
                rows.forEach(row => {
                    const columns = row.split(',');
                    if (columns.length >= 4) {
                        // Normalize medicine names: remove quotes, trim whitespace, convert to lowercase for robust matching
                        const med_en = columns[0].replace(/^"|"$/g, '').trim().toLowerCase();
                        const status_en = columns[1].replace(/^"|"$/g, '').trim();
                        const med_pa = columns[2].replace(/^"|"$/g, '').trim();
                        const status_pa = columns[3].replace(/^"|"$/g, '').trim();
                        
                        if(med_en) stock.en[med_en] = status_en;
                        if(med_pa) stock.pa[med_pa] = status_pa;
                    }
                });
                livePharmacyStock = stock;
                console.log("Live medicine stock updated:", livePharmacyStock);
            } catch (error) {
                console.error("Error processing medicine stock:", error);
            }
        }

        // Call Google Gemini AI to analyze user symptoms and provide health information in the selected language
        async function getAISymptomAnalysis(symptoms) {
            const apiKey = ""; // Add your Google Cloud API key here
            
            // Endpoint for Google Gemini 2.5 Flash model (advanced text generation)
            const apiUrl = ``; // Add your Google Gemini API endpoint here
            
            const languageMap = { en: "English", pa: "Punjabi" };
            const currentLanguageName = languageMap[currentLanguage];

            const systemPrompt = `You are a helpful AI assistant for a telemedicine app in rural Punjab, India. 
            IMPORTANT: You are NOT a doctor. Your analysis is for informational purposes only and is NOT a medical diagnosis. 
            You MUST begin every analysis with a clear disclaimer in ${currentLanguageName}: "Disclaimer: I am an AI assistant and not a medical professional. This is not a diagnosis. Please consult a real doctor for medical advice."
            
            Your task is to analyze the user's reported symptoms. Provide a brief, easy-to-understand analysis. 
            - Suggest 2-3 possible general causes (e.g., 'common cold', 'indigestion').
            - Recommend simple, safe next steps (e.g., 'rest', 'stay hydrated', 'monitor symptoms').
            - Keep the response concise and formatted with bullet points for readability.
            - Your entire response MUST be in ${currentLanguageName}.`;

            const payload = {
                contents: [{ parts: [{ text: symptoms }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    console.error("API response not OK:", response.status, response.statusText);
                    return translations[currentLanguage].aiError;
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text.replace(/\n/g, '<br>');
                } else {
                    console.error("Unexpected API response structure:", result);
                    return translations[currentLanguage].aiError;
                }
            } catch (error) {
                console.error("Error calling AI API:", error);
                return translations[currentLanguage].aiError;
            }
        }

        // Process user text messages: route to medicine lookup or symptom analysis based on conversation state
        async function handleTextMessage(message) {
            const lowerCaseMessage = message.toLowerCase();

            if (conversationState === 'awaiting_medicine') {
                const stock = livePharmacyStock[currentLanguage] || {};
                const foundMedicine = Object.keys(stock).find(med => lowerCaseMessage.includes(med));

                if (foundMedicine) {
                    const status = stock[foundMedicine];
                    addMessage(translations[currentLanguage].pharmacyInfo(foundMedicine, status), 'bot', true);
                } else {
                    addMessage(translations[currentLanguage].unknownMedicine);
                }
            } else { // Default: analyze symptoms if not in medicine lookup mode
                addMessage(translations[currentLanguage].thinking);
                const aiResponse = await getAISymptomAnalysis(message);
                
                if(chatContainer.lastChild) {
                    chatContainer.removeChild(chatContainer.lastChild);
                }
                addMessage(aiResponse, 'bot', true);
            }
            
            // Reset conversation state to idle after message processing is complete
            conversationState = 'idle';
            setTimeout(displayQuickReplies, 1500);
        }
        
        // Send user message: display it in chat, clear input field, and process the message
        function sendMessage() {
            const text = userInput.value.trim();
            if (text) {
                addMessage(text, 'user');
                userInput.value = '';
                quickRepliesContainer.innerHTML = '';
                setTimeout(() => {
                   processPayload(text);
                }, 500);
            }
        }
        
        // Update UI language and reset conversation when user changes language preference
        function updateLanguage() {
            currentLanguage = languageSwitcher.value;
            userInput.placeholder = translations[currentLanguage].inputPlaceholder;
            sendBtn.textContent = translations[currentLanguage].sendButton;
            chatContainer.innerHTML = '';
            quickRepliesContainer.innerHTML = '';
            initializeApp();
        }

        // Event listeners: send message on button click or Enter key press
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        // Update UI when user switches language preference
        languageSwitcher.addEventListener('change', updateLanguage);

        // Initialize the application: display welcome message, fetch medicine stock, and show quick reply options
        async function initializeApp() {
            addMessage(translations[currentLanguage].welcome);
            await fetchMedicineStock();
            displayQuickReplies();
        }

        initializeApp();

    </script>
</body>
</html>

